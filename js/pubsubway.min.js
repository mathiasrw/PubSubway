var pubsubway=function(){var me=this;var proxy={};var doLog=false;var voidAction=false;me.subways=[];me.resetAll=function(){proxy={};doLog=false;voidAction=false;me.subways=[];return me};me.log=function(msg,level){if(doLog&&level<=100){console.log("pub/sub: "+msg)}};me.voidAction=function(val){voidAction=val?true:false};me.doLog=function(val){doLog=val?true:false};me.pub=me.yell=me.publish=function(topic,args){if(topic instanceof Array){for(var i=0;i<topic.length;i++){me.publish(topic[i],args)}}if(voidAction){return me.log("void: "+topic,99)}me.log(topic,100);args=args||[];args=arrayWrap(args);return proxy[topic]&&(this.each(proxy[topic],function(){this.apply(me,args)})?true:false)};me.subREWIND=me.whenREWIND=me.subscribeANDmodeRewind=function(topic,callback,subscribeFirst){me.subscribe(topic,callback,subscribeFirst,"ANDmodeRewind")};me.whenAND=me.subscribeANDmodeContinues=me.subAND=function(topic,callback,subscribeFirst){me.subscribe(topic,callback,subscribeFirst,"ANDmodeContinues")};me.subscribeANDmodeOnce=me.whenAND1=me.subAND1=function(topic,callback,subscribeFirst){me.subscribe(topic,callback,subscribeFirst,"ANDmodeOnce")};me.subORBUT=me.whenORBUT=me.subscribeORmodeButNotIfButResetWith=function(topic,butNotIf,resetWith,callback,subscribeFirst){topic=arrayWrap(topic);butNotIf=arrayWrap(butNotIf);resetWith=arrayWrap(resetWith);var settings=[];settings[0]=topic;settings[1]=butNotIf;settings[2]=resetWith;me.subscribe(settings,callback,subscribeFirst,"ORmodeButNotIfButResetWith")};me.sub=me.when=me.subOR=me.whenOR=me.subscribe=function(topic,callback,subscribeFirst,mode){subscribeFirst=subscribeFirst||false;mode=mode||null;if(null!=mode&&!(topic instanceof Array)){topic=[topic]}if(!(topic instanceof Array)){if(!proxy[topic]){proxy[topic]=[]}if(subscribeFirst){proxy[topic].unshift(callback)}else{proxy[topic].push(callback)}return[topic,callback]}if(null==mode){me.each(topic,function(){me.subscribe(this,callback,mode,subscribeFirst)});return[topic,callback]}var uid=topic.join("#")+"#"+Math.random();me.subways[uid]={};me.subways[uid].mux=[];me.subways[uid].dontRun=false;me.subways[uid].handlers=[];me.subways[uid].handlers.push(me.subscribe(uid,callback));for(var i in topic){me.subways[uid].mux[topic[i]]=1}switch(mode){case"ANDmodeRewind":me.each(topic,function(theme){var theme=this;var thisUid=uid;var handler=me.subscribe(theme,function(){me.subways[thisUid].mux[theme]=0;var total=0;for(var ii in topic){total+=me.subways[thisUid].mux[topic[ii]]}if(0==total){me.publish(thisUid);for(var ii in topic){me.subways[thisUid].mux[topic[ii]]=1}}});me.subways[thisUid].handlers.push(handler)});break;case"ANDmodeContinues":me.each(topic,function(theme){var theme=this;var thisUid=uid;var handler=me.subscribe(theme,function(){me.subways[thisUid].mux[theme]=0;var total=0;for(var ii in topic){total+=me.subways[thisUid].mux[topic[ii]]}if(0==total){me.publish(thisUid)}});me.subways[thisUid].handlers.push(handler)});break;case"ANDmodeOnce":me.each(topic,function(theme){var theme=this;var thisUid=uid;var handler=me.subscribe(theme,function(){if(me.subways[thisUid].dontRun){return}me.subways[thisUid].mux[theme]=0;var total=0;for(var ii in topic){total+=me.subways[thisUid].mux[topic[ii]]}if(0==total){me.publish(thisUid);me.subways[thisUid].dontRun=true}});me.subways[thisUid].handlers.push(handler)});break;case"ORmodeButNotIfButResetWith":if(!(0 in topic&&topic[0]instanceof Array&&1 in topic&&topic[1]instanceof Array&&2 in topic&&topic[2]instanceof Array)){var msg="Wrong pubsub formatting of ORmodeButNotIfButResetWith";me.log(msg,1);return false}var publish=topic[0];var butNotIf=topic[1];var resetWith=topic[2];me.each(resetWith,function(theme){var theme=this;var handler=me.subscribe(theme,function(){me.subways[uid].dontRun=false});me.subways[uid].handlers.push(handler)});me.each(butNotIf,function(theme){var theme=this;var handler=me.subscribe(theme,function(){me.subways[uid].dontRun=true});me.subways[uid].handlers.push(handler)});me.each(publish,function(theme){var theme=this;var handler=me.subscribe(theme,function(){if(me.subways[uid].dontRun){return}me.publish(uid)});me.subways[uid].handlers.push(handler)});break;default:me.log("Wrong mode setting in pubsubway: "+mode,1);return false}return[uid,callback]};me.unsub=me.unsubscribe=function(handle){var topic=handle[0];proxy[topic]&&me.each(proxy[topic],function(id){if(this==handle[1]){proxy[topic].splice(id,1)}})};me.each=function(topics,callback){var i=-1;var length=topics.length;while(++i<length&&callback.call(el=topics[i],i,el)!==false);};var arrayWrap=function(data){if(!(data instanceof Array)){return[data]}return data};me.pubsubBack=function(callbacktopic){callbacktopic=callbacktopic||function(){};if(!(callbacktopic instanceof Function)){var topic=callbacktopic;var args=[];if(1<arguments.length){for(var i=1;i<arguments.length;i++){args.push(arguments[i])}}callbacktopic=function(){me.publish(topic,args)}}return callbacktopic};return me}();if(typeof module!=="undefined"&&typeof module==="object"&&typeof module.exports!=="undefined"){module.exports=pubsubway}